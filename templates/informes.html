{% extends "base.html" %}
{% block content %}
<div class="container mt-4">

  <h1>Generador de Informes con filtro por campo</h1>

  <form action="{{ url_for('informe') }}" method="POST" class="row g-3 mb-4">
    <div class="col-md-3">
      <label for="tipo_informe" class="form-label">Tipo de Informe</label>
      <select id="tipo_informe" name="tipo_informe" class="form-select" required onchange="mostrarCampos()">
        <option value="" disabled selected>Seleccione tipo</option>
        <option value="usuarios" {% if tipo == 'usuarios' %}selected{% endif %}>Usuarios</option>
        <option value="recargas" {% if tipo == 'recargas' %}selected{% endif %}>Recargas</option>
        <option value="rutas" {% if tipo == 'rutas' %}selected{% endif %}>Rutas</option>
        <option value="cooperativas" {% if tipo == 'cooperativas' %}selected{% endif %}>Cooperativas</option>
        <option value="conductores" {% if tipo == 'conductores' %}selected{% endif %}>Conductores</option>
      </select>
    </div>

    <div class="col-md-3" id="campo_filtro_div" style="display:none;">
      <label for="campo" class="form-label">Campo para filtrar</label>
      <select id="campo" name="campo" class="form-select">
        <!-- Opciones dinámicas con JS -->
      </select>
    </div>

    <div class="col-md-3" id="valor_filtro_div" style="display:none;">
      <label for="valor_filtro" class="form-label">Valor filtro</label>
      <input type="text" id="valor_filtro" name="valor_filtro" class="form-control" placeholder="Ingrese valor a filtrar" value="{{ valor_filtro or '' }}">
    </div>

    <div class="col-md-3 d-grid align-self-end">
      <button type="submit" class="btn btn-primary">Generar Informe</button>
    </div>
  </form>

  {% if datos %}
  <hr>
  <h4>Resultados del Informe: {{ tipo|capitalize }} {% if campo %} filtrado por "{{ campo }}" con valor "{{ valor_filtro }}"{% endif %}</h4>

  <table class="table table-bordered table-striped">
    <thead>
      <tr>
        {% if tipo == "usuarios" %}
          <th>ID</th><th>Nombre</th><th>Email</th><th>Fecha Registro</th>
        {% elif tipo == "recargas" %}
          <th>ID</th><th>Usuario</th><th>Monto</th><th>Método de Pago</th><th>Fecha</th>
        {% elif tipo == "rutas" %}
          <th>ID Ruta</th><th>Nombre Ruta</th><th>Descripción</th><th>Fecha Creación</th>
        {% elif tipo == "cooperativas" %}
          <th>ID Cooperativa</th><th>Nombre</th><th>Dirección</th><th>Teléfono</th>
        {% elif tipo == "conductores" %}
          <th>ID Conductor</th><th>Nombre</th><th>Apellido</th><th>Licencia</th><th>Fecha Ingreso</th>
        {% endif %}
      </tr>
    </thead>
    <tbody>
      {% for fila in datos %}
        <tr>
          {% for columna in fila %}
            <td>{{ columna }}</td>
          {% endfor %}
        </tr>
      {% endfor %}
    </tbody>
  </table>
  {% endif %}

</div>

<script>
  const camposPosibles = {{ campos_posibles | tojson }};
  const tipoSeleccionado = "{{ tipo or '' }}";
  const campoSeleccionado = "{{ campo or '' }}";

  function mostrarCampos() {
    const tipoInforme = document.getElementById('tipo_informe').value;
    const campoDiv = document.getElementById('campo_filtro_div');
    const valorDiv = document.getElementById('valor_filtro_div');
    const campoSelect = document.getElementById('campo');

    if (tipoInforme && camposPosibles[tipoInforme]) {
      // Mostrar y llenar opciones
      campoDiv.style.display = 'block';
      valorDiv.style.display = 'block';

      // Limpiar opciones anteriores
      campoSelect.innerHTML = '<option value="" disabled selected>Seleccione campo</option>';

      camposPosibles[tipoInforme].forEach(campo => {
        let option = document.createElement('option');
        option.value = campo;
        option.textContent = campo.replace(/_/g, ' ').toUpperCase();
        if (campo === campoSeleccionado) option.selected = true;
        campoSelect.appendChild(option);
      });

    } else {
      campoDiv.style.display = 'none';
      valorDiv.style.display = 'none';
    }
  }

  // Ejecutar al cargar si ya hay tipo seleccionado
  window.onload = function() {
    if(tipoSeleccionado) {
      document.getElementById('tipo_informe').value = tipoSeleccionado;
      mostrarCampos();
    }
  };
</script>

{% endblock %}
